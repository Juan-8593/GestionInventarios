<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Movimientos - Gesti√≥n de Inventarios</title>
    <link rel="stylesheet" href="css/movimientos.css">
</head>
<body>
<header>
    <h1>Movimientos de Stock</h1>
    <nav class="menu">
        <button onclick="location.href='index.html'">Dashboard</button>
        <button onclick="location.href='productos.html'">Productos</button>
    </nav>
</header>

<section>
    <form id="formMovimiento">
        <select name="productoId" required id="selectProducto"></select>
        <input type="number" name="cantidad" placeholder="Cantidad" min="1" required>
        <select name="tipo" required>
            <option value="Entrada">Entrada</option>
            <option value="Salida">Salida</option>
        </select>
        <input type="text" name="motivo" placeholder="Motivo">
        <button type="submit">Registrar Movimiento</button>
    </form>

    <table id="tablaMovimientos">
        <thead>
        <tr>
            <th>ID</th>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Tipo</th>
            <th>Motivo</th>
            <th>Fecha</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const selectProducto = document.getElementById("selectProducto");
        const tabla = document.querySelector("#tablaMovimientos tbody");
        const form = document.getElementById("formMovimiento");

        // Cargar productos desde localStorage
        let productos = JSON.parse(localStorage.getItem("productos")) || [];
        let movimientos = JSON.parse(localStorage.getItem("movimientos")) || [];

        function cargarProductosSelect() {
            selectProducto.innerHTML = "";
            productos.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.id;
                opt.textContent = p.nombre;
                selectProducto.appendChild(opt);
            });
        }

        function cargarMovimientos() {
            tabla.innerHTML = "";
            movimientos.forEach(m => {
                const producto = productos.find(p => p.id === m.productoId);
                const fila = document.createElement("tr");
                fila.innerHTML = `
                <td>${m.id}</td>
                <td>${producto ? producto.nombre : "Desconocido"}</td>
                <td>${m.cantidad}</td>
                <td>${m.tipo}</td>
                <td>${m.motivo || ""}</td>
                <td>${new Date(m.fecha).toLocaleString()}</td>
            `;
                tabla.appendChild(fila);
            });
        }

        function guardarMovimientos() {
            localStorage.setItem("movimientos", JSON.stringify(movimientos));
            cargarMovimientos();
        }

        // Registrar movimiento
        form.addEventListener("submit", e => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(form));
            const productoId = parseInt(data.productoId);
            const cantidad = parseInt(data.cantidad);

            // Actualizar stock del producto
            const producto = productos.find(p => p.id === productoId);
            if (producto) {
                if (data.tipo === "Entrada") {
                    producto.stock += cantidad;
                } else {
                    producto.stock -= cantidad;
                    if(producto.stock < 0) producto.stock = 0;
                }
                localStorage.setItem("productos", JSON.stringify(productos));
            }

            // Agregar movimiento
            const id = movimientos.length > 0 ? movimientos[movimientos.length-1].id + 1 : 1;
            movimientos.push({
                id: id,
                productoId: productoId,
                cantidad: cantidad,
                tipo: data.tipo,
                motivo: data.motivo,
                fecha: new Date()
            });
            guardarMovimientos();
            form.reset();
        });

        // Inicializar
        cargarProductosSelect();
        cargarMovimientos();
    });
</script>
</body>
</html>
